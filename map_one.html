<!DOCTYPE html>
<!-- This whole line is an HTML comment. ### // this is a single line JS comment. ### /* This is a multiline JS comment or CSS comment (no distinction) */ -->
<html>
<!-- Start of head-->

<head>
  <!-- Set title and encoding -->
  <title>Test map</title>
  <meta charset='utf-8' />
  <!--------------------------------- Imports -------------------------------->
  <!-- Load Leaflet CSS stylesheet remotely via CDN-->
  <link rel='stylesheet' href='https://unpkg.com/leaflet@1.7.1/dist/leaflet.css'
    integrity='sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=='
    crossorigin=''/>
  <!-- Load Leaflet.js library remotely via CDN-->
  <script src='https://unpkg.com/leaflet@1.7.1/dist/leaflet.js'
    integrity='sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=='
    crossorigin=''></script>
  <!-- Load Proj4.js library remotely via CDN-->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.3/proj4.min.js'></script>
  <!-- Load Proj4leaflet library remotely via CDN-->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.min.js'></script>
  <!-- Load jQuery.js library remotely via CDN-->
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
  <!-- Load PapaParse to handle CSV files -->
  <script src='https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js'></script>
  <!-- Load jQuery UI stylesheet via CDN -->
  <link rel='stylesheet' href='https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css'/>
  <!-- Load jQuery UI library via CDN-->
  <script src='https://code.jquery.com/ui/1.12.1/jquery-ui.js'></script>
  <!-- Load europe.js -->
  <script src='./europe.js'></script>
  <!--------------------------------- Styles --------------------------------->
  <style type='text/css'>
    /* Set the background color for the Leaflet map with CSS */
    .leaflet-container {
      background-color: lightblue;
    }
  </style>

  <style>
    /* Set style for autocomplete */
    #autocomplete {
      z-index: 100;
      margin-bottom: 5px;
    }

    /* Set style for map */
    #map {
      width: 1600x;
      height: 700px;
      border: 1px solid black;
      z-index: 0;
      margin-bottom: 20px;
    }

    /* Set style for debugger */
    #debugger {
      width: 1600x;
      height: 40x;
      border: 1px solid black;
    }
  </style>
</head>

<!--------------------------------- Definitions ---------------------------->
<script type='text/javascript'>
  // Add proj4 defs here to use shorthands later
  proj4.defs([
    [
      'EPSG:4326',
      '+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees'
    ],
    [
      'EPSG:3857',
      '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs'
    ],
    [
      'EPSG:3035',
      '+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs'
    ]
  ]);

  // Add custom leaflet icons here
  const recycleIcon = L.icon({
    iconUrl: './img/leaflet_icon/recycle-icon4.svg',
    //shadowUrl: 'leaf-shadow.png',

    iconSize:     [30, 30], // size of the icon
    // shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, -5] // point from which the popup should open relative to the iconAnchor
  });
</script>

<!-- Start of body -->

<body>

  <!-- Create div with UI widget for autocomplete search, inherits style from #autocomplete-->
  <div class='ui-widget' style='text-align:left;'>
    <input id='autocomplete' placeholder='Search for: Country'>
  </div>

  <!-- Create div with map, inherits style from #map -->
  <div id='map'></div>

  <!-- Here we load the data and add it to the map-->
  <script type='text/javascript'>
// @ts-check
    // Path to the Natural Eearth 110m countries
    const naturalEarthPath = 'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_110m_admin_0_countries.geojson';
    // Add AJAX request for Natural Earth data
    const world = $.ajax({
      url:'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_110m_admin_0_countries.geojson',
      dataType: "json",
      success: console.log('Country data successfully loaded.'),
      error: function (xhr) {
        alert(xhr.statusText)
      }
    });
    // Path to Europe with regions GeoJSON
    //const europe = './europe.geojson';
    // Set map style parameters
    const mapStyle = {
      stroke: true, // lines between SVGs/polygons bool
      color: '#ffffff', // line color
      weight: 1, // line width
      dashArray: 3, // dashed line style ??
      fill: true, // fill polygons bool
      fillColor: 'green', // polygon fill color
      fillOpacity: .6, // polygon fill opacity
    }

    // Create the base map
    const map = L.map('map').setView(center = [51.1657, 10.4515], zoom = 4);

    // Adding OSM map // EXAMPLE
    /* var osm=new L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png',{ 
          attribution: '© <a href='http://osm.org/copyright'>OpenStreetMap</a> contributors'});
    var osmBW = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: "© <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"
    }); 

    osmBW.addTo(map) */
    
    /*$.getJSON(europe, function (countries) {
      // let map = L.map('map').setView(center=[51.1657, 10.4515],zoom=4);
      //let germany = $('data[ISO_A3 ='DEU']');
      L.geoJson(countries, {
        clickable: false,
        style: mapStyle
      }).addTo(map);
    })*/

  // Get color depending on value
	function getColor(d) {
		return d > 60000000 ? '#800026' :
				d > 40000000  ? '#BD0026' :
				d > 20000000  ? '#E31A1C' :
				d > 10000000  ? '#FC4E2A' :
				d > 5000000   ? '#FD8D3C' :
				d > 1000000   ? '#FEB24C' :
				d > 10   ? '#FED976' :
							'#FFEDA0';
	}
  // Get style depending on feature (calls getColor)
	function style(feature) {
		return {
			weight: 2,
			opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 0.7,
			fillColor: getColor(feature.properties.pop_est)
		};
	}
  // Highlight hovered over features with a style
	function highlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 5,
			color: '#666',
			dashArray: '',
			fillOpacity: 0.7
		});

    // Only pop layer if not on IE, Opera or Edge, since they are buggy
		if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}
    // Not sure of its purpose
		info.update(layer.feature.properties);
	}
  // Define geojson var, not sure exactly why it needs to be instantiated already
	var geojson;

	function resetHighlight(e) {
		geojson.resetStyle(e.target);
		info.update();
	}
  // Zoom to feature
	function zoomToFeature(e) {
		map.fitBounds(e.target.getBounds());
	}
  // The function  that ties together the cursor dependent behavior
	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight,
			click: zoomToFeature
		});
	}

	geojson = L.geoJson(europe, {
		style: style,
		onEachFeature: onEachFeature
	}).addTo(map);
  







/*
    // Trying to reproject coordinates 
    // Works now, but proj4 accepts lon/lat and retursn lon/lat while leaflet uses lat/lon
    const fromProj = proj4('EPSG:3035');
    const toProj = proj4('EPSG:4326');
    const coords = proj4(fromProj, toProj, [4176035, 3280468]);
    let marker = L.marker([coords[1], coords[0]], {
      opacity: 1
    })

    marker.addTo(map);
*/
    // Markers are currently broken

    // Read markers data from UBC_proc.csv
    const fromProj = proj4('EPSG:3035');
    const toProj = proj4('EPSG:4326');
    $.get('./UBC_proc.csv', function (csvString) {

      // Use PapaParse to convert string to array of objects
      let data = Papa.parse(csvString, {
        header: true,
        dynamicTyping: true
      }).data;

      // For each row in data, create a marker and add it to the map
      // For each row, columns `Latitude`, `Longitude`, and `Title` are required
      for (var i in data) {
        let row = data[i];
        // creating source and destination Proj4js objects
        // once initialized, these may be re-used as often as needed
        //let source = new Proj4js.Proj('EPSG:3035');    //source coordinates in N/E meters, ETRS89-extended
        //let dest = new Proj4js.Proj('EPSG:4326');     //destination coordinates will be in lat-long, WGS84
        // transforming point coordinates
        let p = [Math.round(row.long), Math.round(row.lat)]; //any object will do as long as it has 'x' and 'y' properties
        console.log(p); // WHERE DOES THIS OUTPUT???
        let testp= proj4(fromProj, toProj, p); //do the transformation

        let marker = L.marker([testp[1], testp[0]], {
          icon: recycleIcon,
          opacity: 1
        }).bindPopup(row.name)

        marker.addTo(map)
      }
    })

  </script>








  <!--------------------------------- Debugging/printing sandbox ------------->
  <div id='debugger'>
    <p id='print'></p>
    <script type='text/javascript'>
    /*
      $.get('./UBC_proc.csv', function (csvString) {
        // Use PapaParse to convert string to array of objects
        let data = Papa.parse(csvString, {
          header: true,
          dynamicTyping: true
        }).data;
        let row = data[0];
        document.getElementById('print').innerHTML = row.lat;
      }) */
    </script>
  </div>
</body>

</html>